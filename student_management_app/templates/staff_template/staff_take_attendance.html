{% extends 'base.html' %}
{% block page_title %}Take Attendance{% endblock %}
{% block main_content %}
<div class="container-fluid">
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Take Attendance</h3>
        </div>
        <div class="card-body">
            <div class="form-group"><label>Subject</label><select class="form-control" id="subject" name="subject">
                    <option value="">Select Subject</option>{% for subject in subjects %}<option
                        value="{{ subject.id }}">{{ subject.subject_name }}</option>{% endfor %}
                </select></div>
            <div class="form-group"><label>Session Year</label><select class="form-control" id="session_year_id"
                    name="session_year_id">
                    <option value="">Select Session</option>{% for session in session_years %}<option
                        value="{{ session.id }}">{{ session.session_start_year }} - {{ session.session_end_year }}
                    </option>{% endfor %}
                </select></div>
            <div class="form-group"><label>Attendance Date</label><input type="date" class="form-control"
                    id="attendance_date" name="attendance_date"></div>
            <button type="button" class="btn btn-primary" id="fetch_students">Fetch Students</button>
            <hr>
            <div id="student_data"></div>
        </div>
    </div>
</div>
{% endblock main_content %}
{% block custom_js %}
<script>
    $(document).on('click', '#fetch_students', function () {
        var subject = $('#subject').val();
        var session_year_id = $('#session_year_id').val();
        console.log("Fetching students for subject: " + subject + ", session: " + session_year_id);

        if (subject == '' || session_year_id == '') {
            alert('Please select subject and session');
            return;
        }
        $.ajax({
            url: '{% url "get_students" %}',
            type: 'POST',
            data: { subject: subject, session_year_id: session_year_id },
            success: function (response) {
                console.log("Response received:", response);
                var data = typeof response === "string" ? JSON.parse(response) : response;
                if (data.length == 0) {
                    $('#student_data').html("<div class='alert alert-warning'>No students found for this subject and session.</div>");
                    return;
                }
                var html = '<table class="table table-bordered"><thead><tr><th>Student Name</th><th>Status</th></tr></thead><tbody>';
                for (var i = 0; i < data.length; i++) {
                    html += '<tr><td>' + data[i].name + ' [' + data[i].username + ']</td><td><input type="checkbox" name="student_ids" value="' + data[i].id + '"> Present</td></tr>';
                }
                html += '</tbody></table><button type="button" class="btn btn-success" id="save_attendance">Save Attendance</button>';
                $('#student_data').html(html);
            },
            error: function (xhr, status, error) {
                console.error("AJAX Error:", status, error);
                alert("Error in fetching students! Check console for details.");
            }
        });
    });
    $(document).on('click', '#save_attendance', function () {
        var subject = $('#subject').val();
        var session_year_id = $('#session_year_id').val();
        var attendance_date = $('#attendance_date').val();
        var student_ids = [];
        $('input[name="student_ids"]').each(function () {
            if ($(this).is(":checked")) {
                student_ids.push({ id: $(this).val(), status: 1 });
            }
            else {
                student_ids.push({ id: $(this).val(), status: 0 });
            }
        });
        $.ajax({
            url: '{% url "save_attendance_data" %}',
            type: 'POST',
            data: { subject_id: subject, session_year_id: session_year_id, attendance_date: attendance_date, student_ids: JSON.stringify(student_ids) },
            success: function (response) {
                if (response == "OK") {
                    alert('Attendance saved successfully');
                    location.reload();
                } else {
                    alert('Failed: ' + response);
                }
            },
            error: function () {
                alert("Error in saving attendance!");
            }
        });
    });
</script>
{% endblock custom_js %}