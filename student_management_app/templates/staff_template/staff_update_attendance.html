{% extends 'base.html' %}
{% block page_title %}Update Attendance{% endblock %}
{% block main_content %}
<div class="container-fluid">
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Update Attendance</h3>
        </div>
        <div class="card-body">
            <div class="form-group"><label>Subject</label><select class="form-control" id="subject">
                    <option value="">Select Subject</option>{% for subject in subjects %}<option
                        value="{{ subject.id }}">{{ subject.subject_name }}</option>{% endfor %}
                </select></div>
            <div class="form-group"><label>Session Year</label><select class="form-control" id="session_year_id">
                    <option value="">Select Session</option>{% for session in session_years %}<option
                        value="{{ session.id }}">{{ session.session_start_year }} - {{ session.session_end_year }}
                    </option>{% endfor %}
                </select></div>
            <button type="button" class="btn btn-primary" id="fetch_dates">Fetch Attendance Dates</button>
            <hr>
            <div id="attendance_dates"></div>
            <div id="student_data"></div>
        </div>
    </div>
</div>
{% endblock main_content %}
{% block custom_js %}
<script>
    $(document).on('click', '#fetch_dates', function () {
        var subject = $('#subject').val();
        var session_year_id = $('#session_year_id').val();
        console.log("Fetching dates for subject: " + subject + ", session: " + session_year_id);

        $.ajax({
            url: '{% url "get_attendance_dates" %}',
            type: 'POST',
            data: { subject: subject, session_year_id: session_year_id },
            success: function (response) {
                console.log("Dates received:", response);
                var data = typeof response === "string" ? JSON.parse(response) : response;
                if (data.length == 0) {
                    $('#attendance_dates').html("<div class='alert alert-warning'>No attendance dates found for this subject and session.</div>");
                    return;
                }
                var html = '<div class="form-group"><label>Select Date</label><select class="form-control" id="attendance_date"><option value="">Select Date</option>';
                for (var i = 0; i < data.length; i++) {
                    html += '<option value="' + data[i].id + '">' + data[i].attendance_date + '</option>';
                }
                html += '</select></div><button type="button" class="btn btn-success" id="fetch_students">Fetch Students</button>';
                $('#attendance_dates').html(html);
            },
            error: function (xhr, status, error) {
                console.error("AJAX Error:", status, error);
                alert("Error in fetching dates!");
            }
        });
    });
    $(document).on('click', '#fetch_students', function () {
        var attendance_date = $('#attendance_date').val();
        console.log("Fetching students for attendance date ID: " + attendance_date);

        $.ajax({
            url: '{% url "get_attendance_student" %}',
            type: 'POST',
            data: { attendance_date: attendance_date },
            success: function (response) {
                console.log("Students received:", response);
                var data = typeof response === "string" ? JSON.parse(response) : response;
                if (data.length == 0) {
                    $('#student_data').html("<div class='alert alert-warning'>No student records found for this date.</div>");
                    return;
                }
                var html = '<table class="table table-bordered"><thead><tr><th>Student Name</th><th>Status</th></tr></thead><tbody>';
                for (var i = 0; i < data.length; i++) {
                    html += '<tr><td>' + data[i].name + ' [' + data[i].username + ']</td><td><input type="checkbox" name="student_ids" value="' + data[i].id + '" ' + (data[i].status == 1 ? 'checked' : '') + '> Present</td></tr>';
                }
                html += '</tbody></table><button type="button" class="btn btn-success" id="update_attendance">Update Attendance</button>';
                $('#student_data').html(html);
            },
            error: function (xhr, status, error) {
                console.error("AJAX Error:", status, error);
                alert("Error in fetching students!");
            }
        });
    });
    $(document).on('click', '#update_attendance', function () {
        var attendance_date = $('#attendance_date').val();
        var student_ids = [];
        $('input[name="student_ids"]').each(function () {
            if ($(this).is(":checked")) {
                student_ids.push({ id: $(this).val(), status: 1 });
            }
            else {
                student_ids.push({ id: $(this).val(), status: 0 });
            }
        });
        $.ajax({
            url: '{% url "update_attendance_data" %}',
            type: 'POST',
            data: { attendance_date: attendance_date, student_ids: JSON.stringify(student_ids) },
            success: function (response) {
                if (response == "OK") {
                    alert('Attendance updated successfully');
                    location.reload();
                } else {
                    alert('Failed: ' + response);
                }
            },
            error: function () {
                alert("Error in updating attendance!");
            }
        });
    });
</script>
{% endblock custom_js %}